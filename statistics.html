<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>System Statistics</title>
  <link rel="stylesheet" href="styles2.css" />
  <link rel="stylesheet" href="styles.css" />
  <script src="chat.js"></script>
</head>
<body>
  <div class="chat-container">
  <div class="chat-header">ðŸ’¬ Manager Chat</div>
  <div class="chat-messages" id="chat-box"></div>
  <div class="chat-input">
    <input type="text" id="chat-input" placeholder="Type your message..." />
    <button onclick="sendMessage()">Send</button>
  </div>
</div>

  <div class="app-container">
    <!-- Sidebar -->
    <nav class="sidebar">
      <div class="logo">
        <h2>EnvMonitor</h2>
      </div>
      <ul class="nav-links">
        <li><a href="index.html">Dashboard</a></li>
        <li><a href="alerts.html">Alerts & Recommendations</a></li>
        <li><a href="game.html">Engineer Game Mode</a></li>
        <li class="active"><a href="statistics.html">Statistics</a></li>
        <li><a href="manager.html">Manager Panel</a></li>
      </ul>
           <!-- Message Manager Button at the Bottom -->
           <ul class="nav-links" style="margin-top: 300px; text-align: center;">
            <li><a href="#" class="message-manager">Chat Manager</a></li>
        </ul>
    </nav>

    <!-- Main content -->
    <main class="main-content">
      <nav class="top-nav">
        <div class="nav-left">
          <h1>System Statistics</h1>
        </div>
        <div class="nav-right">
          <span class="status-badge online">System Online</span>
          <span class="time">Last Updated: <span id="lastUpdated">Loading...</span></span>
        </div>
      </nav>

      <div class="dashboard-body">
        <!-- Summary Cards -->
        <div class="sensors-grid">
          <div class="sensor-card">
            <div class="sensor-header">
              <h3>Total Searches</h3>
            </div>
            <div class="sensor-value" id="totalQueries">Loading...</div>
            <div class="sensor-meta"><span>Since launch</span></div>
          </div>

          <div class="sensor-card">
            <div class="sensor-header">
              <h3>Top Search Term</h3>
            </div>
            <div class="sensor-value" id="topSearchTerm">Loading...</div>
            <div class="sensor-meta"><span>Most frequent</span></div>
          </div>

          <div class="sensor-card">
            <div class="sensor-header">
              <h3>Average Response</h3>
            </div>
            <div class="sensor-value" id="avgResponse">Loading...</div>
            <div class="sensor-meta"><span>In seconds</span></div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- JavaScript -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js";
    import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAm2uh6aiNIwlfjxgPLxJLL7auZstt7NW4",
      authDomain: "monitorstats-983e4.firebaseapp.com",
      projectId: "monitorstats-983e4",
      storageBucket: "monitorstats-983e4.firebasestorage.app",
      messagingSenderId: "253864315528",
      appId: "1:253864315528:web:5e9bfa859f7b7901ad2d3d"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const qCol = collection(db, "queries");

    onSnapshot(qCol, (snapshot) => {
      let total = 0;
      let sumResponseTime = 0;
      let termCounts = {};

      snapshot.forEach(doc => {
        const data = doc.data();
        total++;
        sumResponseTime += data.responseTime || 0;

        const term = data.term;
        if (term) {
          termCounts[term] = (termCounts[term] || 0) + 1;
        }
      });

      // Get top search term
      const sortedTerms = Object.entries(termCounts).sort((a, b) => b[1] - a[1]);
      const topTerm = sortedTerms.length > 0 ? sortedTerms[0][0] : "â€”";

      // Update HTML
      document.getElementById("totalQueries").innerText = total;
      document.getElementById("avgResponse").innerText = total > 0 ? (sumResponseTime / total).toFixed(2) + "s" : "0.00s";
      document.getElementById("topSearchTerm").innerText = topTerm;
      document.getElementById("lastUpdated").innerText = new Date().toLocaleTimeString();
    });
  </script>
  <script src="chat.js"></script>
</body>
</html>